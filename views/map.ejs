<!DOCTYPE html>
<html>
  <head>
    <title>Lokalizacja</title>
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>
  </head>
  <body>
    <div id="map" style="height: 500px; width: 100%"></div>
    <script>
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var latitude = position.coords.latitude;
          var longitude = position.coords.longitude;

          console.log("Twoja aktualna lokalizacja:");
          console.log("Szerokość geograficzna:", latitude);
          console.log("Długość geograficzna:", longitude);

          sendLocationToServer(latitude, longitude);
        });
      }

      function sendLocationToServer(latitude, longitude) {
        fetch("http://localhost:3000/map", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ latitude, longitude }),
        })
          .then((response) => response.json())
          .then((data) => {
            var formattedDataJS = data.formattedData;
            var latitudeJS = data.latitude;
            var longitudeJS = data.longitude;

            console.log("Formatted Data in JS:", formattedDataJS);
            console.log("Latitude in JS:", latitudeJS);
            console.log("Longitude in JS:", longitudeJS);

            var map = L.map("map").setView([latitude, longitude], 15);
            L.tileLayer(
              "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic2ViaW5obyIsImEiOiJjbDB4dGQzdGEwOWNtM2lvMWNqNjR1NzloIn0.q9JyLxHUFAS6Mbe_8nxbzQ",
              {
                attribution:
                  'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 20,
                id: "mapbox/streets-v11",
                tileSize: 512,
                zoomOffset: -1,
                accessToken:
                  "pk.eyJ1Ijoic2ViaW5obyIsImEiOiJjbDB4dGQzdGEwOWNtM2lvMWNqNjR1NzloIn0.q9JyLxHUFAS6Mbe_8nxbzQ",
              }
            ).addTo(map);

            // Dodaj marker do mapy
            var marker = L.marker([latitude, longitude]).addTo(map);

            function myFunction(marker) {
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(geoSucc);
              }

              function geoSucc(position) {
                var latitude = marker["_latlng"]["lat"];
                var longitude = marker["_latlng"]["lng"];
                fetch(
                  `https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=fb79dc8c719d42a0ba059f4831c8aaf8`
                )
                  .then((response) => response.json())
                  .then((data) =>
                    marker
                      .bindPopup(data["results"][0]["formatted"])
                      .openPopup()
                  );
              }
            }
          })
          .catch((error) => {
            console.error(
              "Błąd przesyłania danych geograficznych:",
              error.message
            );
          });
      }
    </script>
  </body>
</html>
